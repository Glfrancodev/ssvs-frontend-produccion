import{a as L}from"./chunk-O5GV366U.js";import{a as N}from"./chunk-WIG3ZVDE.js";import{a as z}from"./chunk-3GOBKWC2.js";import{a as D}from"./chunk-VAO66HGS.js";import{B as A}from"./chunk-RDO4C5ZH.js";import"./chunk-4YRY4IP2.js";import{b as O,d as k,e as V,j}from"./chunk-24563CTF.js";import{a as B}from"./chunk-WURDNOJS.js";import{h as R,j as W,o as P}from"./chunk-EALBQTKK.js";import{l as F,q as T}from"./chunk-5DWL5JJZ.js";import{$a as y,Ab as s,Cb as E,Eb as m,Fb as u,Gb as p,Ib as x,Na as c,Oa as d,_ as I,cb as M,ha as h,hb as a,ia as C,ib as n,nb as w,qb as b,ub as l}from"./chunk-3RWLLOHT.js";function H(f,r){if(f&1){let i=w();a(0,"div",12)(1,"h3"),s(2),n(),a(3,"div",2)(4,"label",13),s(5,"Medicamento"),n(),a(6,"input",14),p("ngModelChange",function(t){let o=h(i).$implicit;return u(o.medicamento,t)||(o.medicamento=t),C(t)}),n()(),a(7,"div",2)(8,"label",13),s(9,"Frecuencia"),n(),a(10,"input",14),p("ngModelChange",function(t){let o=h(i).$implicit;return u(o.frecuencia,t)||(o.frecuencia=t),C(t)}),n()(),a(11,"div",2)(12,"label",13),s(13,"Fecha de Inicio"),n(),a(14,"input",15),p("ngModelChange",function(t){let o=h(i).$implicit;return u(o.fechaInicio,t)||(o.fechaInicio=t),C(t)}),n()(),a(15,"div",2)(16,"label",13),s(17,"Fecha Final"),n(),a(18,"input",15),p("ngModelChange",function(t){let o=h(i).$implicit;return u(o.fechaFinal,t)||(o.fechaFinal=t),C(t)}),n()()()}if(f&2){let i=r.$implicit,e=r.index;c(2),E("Receta ",e+1,""),c(2),l("for","medicamento",e,""),c(2),l("id","medicamento",e,""),l("name","medicamento",e,""),m("ngModel",i.medicamento),c(2),l("for","frecuencia",e,""),c(2),l("id","frecuencia",e,""),l("name","frecuencia",e,""),m("ngModel",i.frecuencia),c(2),l("for","fechaInicio",e,""),c(2),l("id","fechaInicio",e,""),l("name","fechaInicio",e,""),m("ngModel",i.fechaInicio),c(2),l("for","fechaFinal",e,""),c(2),l("id","fechaFinal",e,""),l("name","fechaFinal",e,""),m("ngModel",i.fechaFinal)}}var _=class f{constructor(r,i,e,t,o,v,g,S){this.route=r;this.consultaService=i;this.tratamientoService=e;this.recetaService=t;this.cupoService=o;this.router=v;this.bitacoraService=g;this.authService=S}motivo="";diagnostico="";nota="";recetas=[];cupoId;historiaClinicaId;ngOnInit(){this.cupoId=Number(this.route.snapshot.paramMap.get("cupoId")),this.cupoId&&this.obtenerHistoriaClinicaIdDesdeCupo(this.cupoId)}obtenerHistoriaClinicaIdDesdeCupo(r){this.cupoService.getCupoById(r).subscribe(i=>{i&&i.asegurado&&i.asegurado.historiaClinica?(this.historiaClinicaId=i.asegurado.historiaClinica.id,console.log("Historia Cl\xEDnica ID obtenida:",this.historiaClinicaId)):console.error("No se encontr\xF3 la historia cl\xEDnica para el asegurado en el cupo especificado.")},i=>{console.error("Error al obtener el cupo:",i)})}agregarReceta(){this.recetas.push({medicamento:"",frecuencia:"",fechaInicio:"",fechaFinal:""})}guardarConsulta(){if(!this.cupoId||!this.historiaClinicaId){console.error("Faltan datos para guardar la consulta.");return}let r={fechaConsulta:new Date().toISOString().split("T")[0],motivoConsulta:this.motivo,diagnostico:this.diagnostico,nota:this.nota,cupo:{id:this.cupoId,numero:0,fechaReservado:"",hora:"",estado:"",horario:void 0,asegurado:void 0},historiaClinica:{id:this.historiaClinicaId}};this.consultaService.createConsulta(r).subscribe(i=>{if(console.log("Consulta guardada:",i),this.registrarBitacora("Guardar consulta",`Consulta de ${this.cupoId} de ${r.cupo?.asegurado?.usuario?.nombre||"asegurado"} a\xF1adida`),this.recetas.length>0){let e={fecha:i.fechaConsulta,consulta:{id:i.id,fechaConsulta:"",motivoConsulta:"",diagnostico:"",nota:"",cupo:void 0,historiaClinica:void 0}};this.tratamientoService.createTratamiento(e).subscribe(t=>{console.log("Tratamiento guardado:",t),this.registrarBitacora("Guardar tratamiento",`Tratamiento ${t.id} generado para consulta ${i.id}`),this.recetas.forEach(o=>{let v={medicamento:o.medicamento,frecuencia:o.frecuencia,fechaInicio:o.fechaInicio,fechaFinal:o.fechaFinal,tratamiento:{id:t.id,fecha:""}};this.recetaService.createReceta(v).subscribe(g=>{console.log("Receta guardada:",g),this.registrarBitacora("Guardar receta",`Receta ${g.id} para tratamiento ${t.id}`)},g=>{console.error("Error al guardar receta:",g)})}),this.actualizarEstadoCupo()},t=>{console.error("Error al guardar el tratamiento:",t)})}else this.actualizarEstadoCupo()},i=>{console.error("Error al guardar la consulta:",i)})}actualizarEstadoCupo(){this.cupoService.actualizarEstadoCupo(this.cupoId,"Terminado").subscribe(r=>{console.log('Estado del cupo actualizado a "Terminado":',r),this.router.navigate(["/dashboard"])},r=>{console.error("Error al actualizar el estado del cupo:",r)})}registrarBitacora(r,i){this.bitacoraService.getUserIP().subscribe({next:e=>{let t=new Date,o=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`,v=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`,g={correo:this.authService.getAuthenticatedUserEmail()||"",fecha:o,hora:v,ip:e.ip,accion:r,detalle:i};this.bitacoraService.createBitacora(g).subscribe({next:()=>console.log("Registro de bit\xE1cora exitoso"),error:S=>console.error("Error al registrar en bit\xE1cora",S)})},error:e=>console.error("Error al obtener IP",e)})}static \u0275fac=function(i){return new(i||f)(d(R),d(z),d(N),d(L),d(D),d(W),d(B),d(P))};static \u0275cmp=I({type:f,selectors:[["app-consulta"]],standalone:!0,features:[x],decls:22,vars:4,consts:[[1,"consulta-container"],[1,"form"],[1,"form-field"],["for","motivo",1,"label"],["id","motivo","name","motivo",1,"textarea",3,"ngModelChange","ngModel"],["for","diagnostico",1,"label"],["id","diagnostico","name","diagnostico",1,"textarea",3,"ngModelChange","ngModel"],["for","nota",1,"label"],["id","nota","name","nota",1,"textarea",3,"ngModelChange","ngModel"],["class","form receta-form",4,"ngFor","ngForOf"],[1,"button-container"],["type","button",1,"button",3,"click"],[1,"form","receta-form"],[1,"label",3,"for"],[1,"textarea",3,"ngModelChange","id","ngModel","name"],["type","date",1,"textarea",3,"ngModelChange","id","ngModel","name"]],template:function(i,e){i&1&&(a(0,"div",0)(1,"div",1)(2,"h3"),s(3,"Detalles de la Consulta"),n(),a(4,"div",2)(5,"label",3),s(6,"Motivo"),n(),a(7,"textarea",4),p("ngModelChange",function(o){return u(e.motivo,o)||(e.motivo=o),o}),n()(),a(8,"div",2)(9,"label",5),s(10,"Diagn\xF3stico"),n(),a(11,"textarea",6),p("ngModelChange",function(o){return u(e.diagnostico,o)||(e.diagnostico=o),o}),n()(),a(12,"div",2)(13,"label",7),s(14,"Nota"),n(),a(15,"textarea",8),p("ngModelChange",function(o){return u(e.nota,o)||(e.nota=o),o}),n()(),y(16,H,19,29,"div",9),a(17,"div",10)(18,"button",11),b("click",function(){return e.agregarReceta()}),s(19,"Agregar Receta"),n(),a(20,"button",11),b("click",function(){return e.guardarConsulta()}),s(21,"Guardar Consulta"),n()()()()),i&2&&(c(7),m("ngModel",e.motivo),c(4),m("ngModel",e.diagnostico),c(4),m("ngModel",e.nota),c(),M("ngForOf",e.recetas))},dependencies:[T,F,A,j,O,k,V],styles:[".consulta-container[_ngcontent-%COMP%]{max-width:100%;margin:auto;padding:1.5rem;background-color:#f9f9f9;border-radius:12px;box-shadow:0 4px 8px #0000001a}.consulta-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.8rem;font-weight:700;color:#3f51b5;text-align:center;margin-bottom:1rem}.form-field[_ngcontent-%COMP%]{display:flex;flex-direction:column;margin-bottom:1rem}.label[_ngcontent-%COMP%]{font-weight:700;color:#333;margin-bottom:.25rem}.textarea[_ngcontent-%COMP%], .input-field[_ngcontent-%COMP%]{width:100%;padding:.5rem;border-radius:6px;border:1px solid #ddd;background-color:#fff;font-size:.95rem}.button-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-top:1.5rem}.button[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:700;cursor:pointer;transition:background-color .3s}.button[_ngcontent-%COMP%]:hover{background-color:#388e3c}"]})};export{_ as default};
