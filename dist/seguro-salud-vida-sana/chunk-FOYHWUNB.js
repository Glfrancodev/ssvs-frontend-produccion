import{a as J}from"./chunk-FGZTIKSY.js";import{a as X}from"./chunk-U3KGF4RJ.js";import{a as Q}from"./chunk-UJ32YO6L.js";import{a as Y}from"./chunk-3SAWW7K3.js";import{B as K}from"./chunk-LJKAMAZ5.js";import{b as H,d as $,e as U,j as q}from"./chunk-W5NNSEVP.js";import"./chunk-4YRY4IP2.js";import{a as L}from"./chunk-S2R25WKX.js";import{h as D,j as z,o as N}from"./chunk-V6WZIOIM.js";import{l as B,m as j,q as k,r as V}from"./chunk-2HP4KZBQ.js";import{$a as S,Ab as O,Bb as u,Cb as p,Db as g,Fb as A,Ka as c,La as m,Pb as R,Qb as W,X as E,Ya as b,ea as h,eb as n,fa as v,fb as a,gb as T,kb as y,n as x,nb as C,ob as F,rb as s,xb as l,zb as P}from"./chunk-TOSOZOFE.js";import{i as w}from"./chunk-ODN5LVDJ.js";function Z(d,r){if(d&1){let t=y();n(0,"div",15)(1,"h3"),l(2),a(),n(3,"div",2)(4,"label",16),l(5,"Medicamento"),a(),n(6,"input",17),g("ngModelChange",function(i){let o=h(t).$implicit;return p(o.medicamento,i)||(o.medicamento=i),v(i)}),a()(),n(7,"div",2)(8,"label",16),l(9,"Frecuencia"),a(),n(10,"input",17),g("ngModelChange",function(i){let o=h(t).$implicit;return p(o.frecuencia,i)||(o.frecuencia=i),v(i)}),a()(),n(11,"div",2)(12,"label",16),l(13,"Fecha de Inicio"),a(),n(14,"input",18),g("ngModelChange",function(i){let o=h(t).$implicit;return p(o.fechaInicio,i)||(o.fechaInicio=i),v(i)}),a()(),n(15,"div",2)(16,"label",16),l(17,"Fecha Final"),a(),n(18,"input",18),g("ngModelChange",function(i){let o=h(t).$implicit;return p(o.fechaFinal,i)||(o.fechaFinal=i),v(i)}),a()()()}if(d&2){let t=r.$implicit,e=r.index;c(2),P("Receta ",e+1,""),c(2),s("for","medicamento",e,""),c(2),s("id","medicamento",e,""),s("name","medicamento",e,""),u("ngModel",t.medicamento),c(2),s("for","frecuencia",e,""),c(2),s("id","frecuencia",e,""),s("name","frecuencia",e,""),u("ngModel",t.frecuencia),c(2),s("for","fechaInicio",e,""),c(2),s("id","fechaInicio",e,""),s("name","fechaInicio",e,""),u("ngModel",t.fechaInicio),c(2),s("for","fechaFinal",e,""),c(2),s("id","fechaFinal",e,""),s("name","fechaFinal",e,""),u("ngModel",t.fechaFinal)}}function G(d,r){if(d&1){let t=y();n(0,"li"),l(1),R(2,"number"),n(3,"button",19),C("click",function(){let i=h(t).index,o=F();return v(o.eliminarArchivo(i))}),l(4,"Eliminar"),a()()}if(d&2){let t=r.$implicit;c(),O(" ",t.name," (",W(2,2,t.size/1024,"1.0-2")," KB) ")}}function ee(d,r){d&1&&(n(0,"div",20)(1,"div",21),T(2,"div",22),n(3,"p"),l(4,"Guardando, por favor espere..."),a()()())}var I=class d{constructor(r,t,e,i,o,_,f,M){this.route=r;this.consultaService=t;this.tratamientoService=e;this.recetaService=i;this.cupoService=o;this.router=_;this.bitacoraService=f;this.authService=M}motivo="";diagnostico="";nota="";recetas=[];cupoId;historiaClinicaId;archivosAdjuntos=[];cargando=!1;ngOnInit(){this.cupoId=Number(this.route.snapshot.paramMap.get("cupoId")),this.cupoId&&this.obtenerHistoriaClinicaIdDesdeCupo(this.cupoId)}seleccionarArchivos(r){let t=r.target;t.files&&Array.from(t.files).forEach(e=>{this.archivosAdjuntos.push(e)})}eliminarArchivo(r){this.archivosAdjuntos.splice(r,1)}obtenerHistoriaClinicaIdDesdeCupo(r){this.cupoService.getCupoById(r).subscribe(t=>{t&&t.asegurado&&t.asegurado.historiaClinica?(this.historiaClinicaId=t.asegurado.historiaClinica.id,console.log("Historia Cl\xEDnica ID obtenida:",this.historiaClinicaId)):console.error("No se encontr\xF3 la historia cl\xEDnica para el asegurado en el cupo especificado.")},t=>{console.error("Error al obtener el cupo:",t)})}agregarReceta(){this.recetas.push({medicamento:"",frecuencia:"",fechaInicio:"",fechaFinal:""})}guardarConsulta(){if(!this.cupoId||!this.historiaClinicaId){console.error("Faltan datos para guardar la consulta.");return}let r={fechaConsulta:new Date().toISOString().split("T")[0],motivoConsulta:this.motivo,diagnostico:this.diagnostico,nota:this.nota,cupo:{id:this.cupoId,numero:0,fechaReservado:"",hora:"",estado:"",horario:void 0,asegurado:void 0},historiaClinica:{id:this.historiaClinicaId}};this.consultaService.createConsulta(r).subscribe(t=>w(this,null,function*(){if(console.log("Consulta guardada:",t),t.id){this.cargando=!0,this.mostrarCargando(!0);try{let e=this.archivosAdjuntos.map(i=>x(this.consultaService.subirArchivoConsulta(i,t.id)));yield Promise.all(e),console.log("Todos los archivos subidos correctamente.")}catch(e){console.error("Error al subir archivos:",e)}finally{this.cargando=!1,this.mostrarCargando(!1)}}else console.error("El ID de la consulta guardada es undefined.");if(this.registrarBitacora("Guardar consulta",`Consulta de ${this.cupoId} de ${r.cupo?.asegurado?.usuario?.nombre||"asegurado"} a\xF1adida`),this.recetas.length>0){let e={fecha:t.fechaConsulta,consulta:{id:t.id,fechaConsulta:"",motivoConsulta:"",diagnostico:"",nota:"",cupo:void 0,historiaClinica:void 0}};this.tratamientoService.createTratamiento(e).subscribe(i=>{console.log("Tratamiento guardado:",i),this.registrarBitacora("Guardar tratamiento",`Tratamiento ${i.id} generado para consulta ${t.id}`),this.recetas.forEach(o=>{let _={medicamento:o.medicamento,frecuencia:o.frecuencia,fechaInicio:o.fechaInicio,fechaFinal:o.fechaFinal,tratamiento:{id:i.id,fecha:""}};this.recetaService.createReceta(_).subscribe(f=>{console.log("Receta guardada:",f),this.registrarBitacora("Guardar receta",`Receta ${f.id} para tratamiento ${i.id}`)},f=>{console.error("Error al guardar receta:",f)})}),this.actualizarEstadoCupo()},i=>{console.error("Error al guardar el tratamiento:",i)})}else this.actualizarEstadoCupo()}),t=>{console.error("Error al guardar la consulta:",t)})}mostrarCargando(r){console.log(r?"Mostrando indicador de carga...":"Ocultando indicador de carga...")}actualizarEstadoCupo(){this.cupoService.actualizarEstadoCupo(this.cupoId,"Terminado").subscribe(r=>{console.log('Estado del cupo actualizado a "Terminado":',r),this.router.navigate(["/dashboard"])},r=>{console.error("Error al actualizar el estado del cupo:",r)})}registrarBitacora(r,t){this.bitacoraService.getUserIP().subscribe({next:e=>{let i=new Date,o=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,_=`${i.getHours().toString().padStart(2,"0")}:${i.getMinutes().toString().padStart(2,"0")}:${i.getSeconds().toString().padStart(2,"0")}`,f={correo:this.authService.getAuthenticatedUserEmail()||"",fecha:o,hora:_,ip:e.ip,accion:r,detalle:t};this.bitacoraService.createBitacora(f).subscribe({next:()=>console.log("Registro de bit\xE1cora exitoso"),error:M=>console.error("Error al registrar en bit\xE1cora",M)})},error:e=>console.error("Error al obtener IP",e)})}static \u0275fac=function(t){return new(t||d)(m(D),m(J),m(Q),m(X),m(Y),m(z),m(L),m(N))};static \u0275cmp=E({type:d,selectors:[["app-consulta"]],standalone:!0,features:[A],decls:29,vars:6,consts:[[1,"consulta-container"],[1,"form"],[1,"form-field"],["for","motivo",1,"label"],["id","motivo","name","motivo",1,"textarea",3,"ngModelChange","ngModel"],["for","diagnostico",1,"label"],["id","diagnostico","name","diagnostico",1,"textarea",3,"ngModelChange","ngModel"],["for","nota",1,"label"],["id","nota","name","nota",1,"textarea",3,"ngModelChange","ngModel"],["class","form receta-form",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],["type","file","multiple","",3,"change"],[1,"button-container"],["type","button",1,"button",3,"click"],["class","overlay",4,"ngIf"],[1,"form","receta-form"],[1,"label",3,"for"],[1,"textarea",3,"ngModelChange","id","ngModel","name"],["type","date",1,"textarea",3,"ngModelChange","id","ngModel","name"],["type","button",1,"delete-button",3,"click"],[1,"overlay"],[1,"overlay-content"],[1,"spinner"]],template:function(t,e){t&1&&(n(0,"div",0)(1,"div",1)(2,"h3"),l(3,"Detalles de la Consulta"),a(),n(4,"div",2)(5,"label",3),l(6,"Motivo"),a(),n(7,"textarea",4),g("ngModelChange",function(o){return p(e.motivo,o)||(e.motivo=o),o}),a()(),n(8,"div",2)(9,"label",5),l(10,"Diagn\xF3stico"),a(),n(11,"textarea",6),g("ngModelChange",function(o){return p(e.diagnostico,o)||(e.diagnostico=o),o}),a()(),n(12,"div",2)(13,"label",7),l(14,"Nota"),a(),n(15,"textarea",8),g("ngModelChange",function(o){return p(e.nota,o)||(e.nota=o),o}),a()(),b(16,Z,19,29,"div",9),n(17,"div",2)(18,"h3"),l(19,"Archivos Adjuntos"),a(),n(20,"ul"),b(21,G,5,5,"li",10),a(),n(22,"input",11),C("change",function(o){return e.seleccionarArchivos(o)}),a()(),n(23,"div",12)(24,"button",13),C("click",function(){return e.agregarReceta()}),l(25,"Agregar Receta"),a(),n(26,"button",13),C("click",function(){return e.guardarConsulta()}),l(27,"Guardar Consulta"),a()()()(),b(28,ee,5,0,"div",14)),t&2&&(c(7),u("ngModel",e.motivo),c(4),u("ngModel",e.diagnostico),c(4),u("ngModel",e.nota),c(),S("ngForOf",e.recetas),c(5),S("ngForOf",e.archivosAdjuntos),c(7),S("ngIf",e.cargando))},dependencies:[V,B,j,k,K,q,H,$,U],styles:[".consulta-container[_ngcontent-%COMP%]{max-width:100%;margin:auto;padding:1.5rem;background-color:#f9f9f9;border-radius:12px;box-shadow:0 4px 8px #0000001a}.consulta-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.8rem;font-weight:700;color:#3f51b5;text-align:center;margin-bottom:1rem}.form-field[_ngcontent-%COMP%]{display:flex;flex-direction:column;margin-bottom:1rem}.label[_ngcontent-%COMP%]{font-weight:700;color:#333;margin-bottom:.25rem}.textarea[_ngcontent-%COMP%], .input-field[_ngcontent-%COMP%]{width:100%;padding:.5rem;border-radius:6px;border:1px solid #ddd;background-color:#fff;font-size:.95rem}.button-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-top:1.5rem}.button[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:700;cursor:pointer;transition:background-color .3s}.button[_ngcontent-%COMP%]:hover{background-color:#388e3c}.overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000000b3;display:flex;justify-content:center;align-items:center;z-index:1000;pointer-events:all}.overlay-content[_ngcontent-%COMP%]{text-align:center;color:#fff}.spinner[_ngcontent-%COMP%]{border:8px solid rgba(255,255,255,.3);border-top:8px solid white;border-radius:50%;width:60px;height:60px;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin:0 auto 1rem}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}"]})};export{I as default};
