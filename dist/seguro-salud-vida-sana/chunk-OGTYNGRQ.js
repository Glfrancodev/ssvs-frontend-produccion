import{a as U}from"./chunk-XMUJ5MQB.js";import{a as Y}from"./chunk-RNAEX5BX.js";import{a as K}from"./chunk-AXDIQGGH.js";import{a as $}from"./chunk-VDA7DZUU.js";import{B as H}from"./chunk-ZUZBKQRE.js";import{b as D,d as z,e as L,j as N}from"./chunk-BDNZXGBE.js";import"./chunk-4YRY4IP2.js";import{a as V}from"./chunk-J46H7NZA.js";import{h as O,j,o as k}from"./chunk-XYYWSSR3.js";import{l as R,q as W,r as B}from"./chunk-Y5VG4NV3.js";import{Ab as u,Bb as p,Cb as g,Eb as T,Ja as c,Ka as d,Ob as A,Pb as P,W as w,Xa as b,_a as S,da as h,db as n,ea as v,eb as r,jb as I,mb as C,nb as E,qb as s,wb as l,yb as x,zb as F}from"./chunk-VM3UWR7T.js";import"./chunk-ODN5LVDJ.js";function q(m,a){if(m&1){let i=I();n(0,"div",14)(1,"h3"),l(2),r(),n(3,"div",2)(4,"label",15),l(5,"Medicamento"),r(),n(6,"input",16),g("ngModelChange",function(t){let o=h(i).$implicit;return p(o.medicamento,t)||(o.medicamento=t),v(t)}),r()(),n(7,"div",2)(8,"label",15),l(9,"Frecuencia"),r(),n(10,"input",16),g("ngModelChange",function(t){let o=h(i).$implicit;return p(o.frecuencia,t)||(o.frecuencia=t),v(t)}),r()(),n(11,"div",2)(12,"label",15),l(13,"Fecha de Inicio"),r(),n(14,"input",17),g("ngModelChange",function(t){let o=h(i).$implicit;return p(o.fechaInicio,t)||(o.fechaInicio=t),v(t)}),r()(),n(15,"div",2)(16,"label",15),l(17,"Fecha Final"),r(),n(18,"input",17),g("ngModelChange",function(t){let o=h(i).$implicit;return p(o.fechaFinal,t)||(o.fechaFinal=t),v(t)}),r()()()}if(m&2){let i=a.$implicit,e=a.index;c(2),x("Receta ",e+1,""),c(2),s("for","medicamento",e,""),c(2),s("id","medicamento",e,""),s("name","medicamento",e,""),u("ngModel",i.medicamento),c(2),s("for","frecuencia",e,""),c(2),s("id","frecuencia",e,""),s("name","frecuencia",e,""),u("ngModel",i.frecuencia),c(2),s("for","fechaInicio",e,""),c(2),s("id","fechaInicio",e,""),s("name","fechaInicio",e,""),u("ngModel",i.fechaInicio),c(2),s("for","fechaFinal",e,""),c(2),s("id","fechaFinal",e,""),s("name","fechaFinal",e,""),u("ngModel",i.fechaFinal)}}function J(m,a){if(m&1){let i=I();n(0,"li"),l(1),A(2,"number"),n(3,"button",18),C("click",function(){let t=h(i).index,o=E();return v(o.eliminarArchivo(t))}),l(4,"Eliminar"),r()()}if(m&2){let i=a.$implicit;c(),F(" ",i.name," (",P(2,2,i.size/1024,"1.0-2")," KB) ")}}var y=class m{constructor(a,i,e,t,o,_,f,M){this.route=a;this.consultaService=i;this.tratamientoService=e;this.recetaService=t;this.cupoService=o;this.router=_;this.bitacoraService=f;this.authService=M}motivo="";diagnostico="";nota="";recetas=[];cupoId;historiaClinicaId;archivosAdjuntos=[];ngOnInit(){this.cupoId=Number(this.route.snapshot.paramMap.get("cupoId")),this.cupoId&&this.obtenerHistoriaClinicaIdDesdeCupo(this.cupoId)}seleccionarArchivos(a){let i=a.target;i.files&&Array.from(i.files).forEach(e=>{this.archivosAdjuntos.push(e)})}eliminarArchivo(a){this.archivosAdjuntos.splice(a,1)}obtenerHistoriaClinicaIdDesdeCupo(a){this.cupoService.getCupoById(a).subscribe(i=>{i&&i.asegurado&&i.asegurado.historiaClinica?(this.historiaClinicaId=i.asegurado.historiaClinica.id,console.log("Historia Cl\xEDnica ID obtenida:",this.historiaClinicaId)):console.error("No se encontr\xF3 la historia cl\xEDnica para el asegurado en el cupo especificado.")},i=>{console.error("Error al obtener el cupo:",i)})}agregarReceta(){this.recetas.push({medicamento:"",frecuencia:"",fechaInicio:"",fechaFinal:""})}guardarConsulta(){if(!this.cupoId||!this.historiaClinicaId){console.error("Faltan datos para guardar la consulta.");return}let a={fechaConsulta:new Date().toISOString().split("T")[0],motivoConsulta:this.motivo,diagnostico:this.diagnostico,nota:this.nota,cupo:{id:this.cupoId,numero:0,fechaReservado:"",hora:"",estado:"",horario:void 0,asegurado:void 0},historiaClinica:{id:this.historiaClinicaId}};this.consultaService.createConsulta(a).subscribe(i=>{if(console.log("Consulta guardada:",i),i.id?this.archivosAdjuntos.forEach(e=>{this.consultaService.subirArchivoConsulta(e,i.id).subscribe({next:t=>console.log("Archivo subido:",t),error:t=>console.error("Error al subir archivo:",t)})}):console.error("El ID de la consulta guardada es undefined."),this.registrarBitacora("Guardar consulta",`Consulta de ${this.cupoId} de ${a.cupo?.asegurado?.usuario?.nombre||"asegurado"} a\xF1adida`),this.recetas.length>0){let e={fecha:i.fechaConsulta,consulta:{id:i.id,fechaConsulta:"",motivoConsulta:"",diagnostico:"",nota:"",cupo:void 0,historiaClinica:void 0}};this.tratamientoService.createTratamiento(e).subscribe(t=>{console.log("Tratamiento guardado:",t),this.registrarBitacora("Guardar tratamiento",`Tratamiento ${t.id} generado para consulta ${i.id}`),this.recetas.forEach(o=>{let _={medicamento:o.medicamento,frecuencia:o.frecuencia,fechaInicio:o.fechaInicio,fechaFinal:o.fechaFinal,tratamiento:{id:t.id,fecha:""}};this.recetaService.createReceta(_).subscribe(f=>{console.log("Receta guardada:",f),this.registrarBitacora("Guardar receta",`Receta ${f.id} para tratamiento ${t.id}`)},f=>{console.error("Error al guardar receta:",f)})}),this.actualizarEstadoCupo()},t=>{console.error("Error al guardar el tratamiento:",t)})}else this.actualizarEstadoCupo()},i=>{console.error("Error al guardar la consulta:",i)})}actualizarEstadoCupo(){this.cupoService.actualizarEstadoCupo(this.cupoId,"Terminado").subscribe(a=>{console.log('Estado del cupo actualizado a "Terminado":',a),this.router.navigate(["/dashboard"])},a=>{console.error("Error al actualizar el estado del cupo:",a)})}registrarBitacora(a,i){this.bitacoraService.getUserIP().subscribe({next:e=>{let t=new Date,o=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`,_=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`,f={correo:this.authService.getAuthenticatedUserEmail()||"",fecha:o,hora:_,ip:e.ip,accion:a,detalle:i};this.bitacoraService.createBitacora(f).subscribe({next:()=>console.log("Registro de bit\xE1cora exitoso"),error:M=>console.error("Error al registrar en bit\xE1cora",M)})},error:e=>console.error("Error al obtener IP",e)})}static \u0275fac=function(i){return new(i||m)(d(O),d(U),d(K),d(Y),d($),d(j),d(V),d(k))};static \u0275cmp=w({type:m,selectors:[["app-consulta"]],standalone:!0,features:[T],decls:28,vars:5,consts:[[1,"consulta-container"],[1,"form"],[1,"form-field"],["for","motivo",1,"label"],["id","motivo","name","motivo",1,"textarea",3,"ngModelChange","ngModel"],["for","diagnostico",1,"label"],["id","diagnostico","name","diagnostico",1,"textarea",3,"ngModelChange","ngModel"],["for","nota",1,"label"],["id","nota","name","nota",1,"textarea",3,"ngModelChange","ngModel"],["class","form receta-form",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],["type","file","multiple","",3,"change"],[1,"button-container"],["type","button",1,"button",3,"click"],[1,"form","receta-form"],[1,"label",3,"for"],[1,"textarea",3,"ngModelChange","id","ngModel","name"],["type","date",1,"textarea",3,"ngModelChange","id","ngModel","name"],["type","button",1,"delete-button",3,"click"]],template:function(i,e){i&1&&(n(0,"div",0)(1,"div",1)(2,"h3"),l(3,"Detalles de la Consulta"),r(),n(4,"div",2)(5,"label",3),l(6,"Motivo"),r(),n(7,"textarea",4),g("ngModelChange",function(o){return p(e.motivo,o)||(e.motivo=o),o}),r()(),n(8,"div",2)(9,"label",5),l(10,"Diagn\xF3stico"),r(),n(11,"textarea",6),g("ngModelChange",function(o){return p(e.diagnostico,o)||(e.diagnostico=o),o}),r()(),n(12,"div",2)(13,"label",7),l(14,"Nota"),r(),n(15,"textarea",8),g("ngModelChange",function(o){return p(e.nota,o)||(e.nota=o),o}),r()(),b(16,q,19,29,"div",9),n(17,"div",2)(18,"h3"),l(19,"Archivos Adjuntos"),r(),n(20,"ul"),b(21,J,5,5,"li",10),r(),n(22,"input",11),C("change",function(o){return e.seleccionarArchivos(o)}),r()(),n(23,"div",12)(24,"button",13),C("click",function(){return e.agregarReceta()}),l(25,"Agregar Receta"),r(),n(26,"button",13),C("click",function(){return e.guardarConsulta()}),l(27,"Guardar Consulta"),r()()()()),i&2&&(c(7),u("ngModel",e.motivo),c(4),u("ngModel",e.diagnostico),c(4),u("ngModel",e.nota),c(),S("ngForOf",e.recetas),c(5),S("ngForOf",e.archivosAdjuntos))},dependencies:[B,R,W,H,N,D,z,L],styles:[".consulta-container[_ngcontent-%COMP%]{max-width:100%;margin:auto;padding:1.5rem;background-color:#f9f9f9;border-radius:12px;box-shadow:0 4px 8px #0000001a}.consulta-container[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:1.8rem;font-weight:700;color:#3f51b5;text-align:center;margin-bottom:1rem}.form-field[_ngcontent-%COMP%]{display:flex;flex-direction:column;margin-bottom:1rem}.label[_ngcontent-%COMP%]{font-weight:700;color:#333;margin-bottom:.25rem}.textarea[_ngcontent-%COMP%], .input-field[_ngcontent-%COMP%]{width:100%;padding:.5rem;border-radius:6px;border:1px solid #ddd;background-color:#fff;font-size:.95rem}.button-container[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-top:1.5rem}.button[_ngcontent-%COMP%]{background-color:#4caf50;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:700;cursor:pointer;transition:background-color .3s}.button[_ngcontent-%COMP%]:hover{background-color:#388e3c}"]})};export{y as default};
